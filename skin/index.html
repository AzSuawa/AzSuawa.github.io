<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>上传皮肤到服务器 - 素素の生存服(p≧w≦q)</title><meta name="description" content="上传皮肤到服务器 - 素素の生存服、azsu.top、小小素QQ机器人"><meta name="theme-color" content="#A1BDFF"><link rel="stylesheet" href="/css/all.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="icon" href="/images/favicon.ico"><style>.skin-upload-container{max-width:500px;margin:0 auto}.skin-drop-area{border:2px dashed #6c757d;border-radius:6px;padding:30px;text-align:center;margin-bottom:20px;transition:all .3s;background:#f8f9fa}.skin-drop-area.highlight{border-color:#28a745;background:#e8f5e9}.skin-btn{background:var(--primary-color);color:#fff;padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-size:16px;margin:10px 5px;transition:background-color .3s}.skin-btn:hover{background:#8CAEFF}.skin-progress-container{margin-top:20px;display:none}.skin-progress{width:100%;height:20px;border-radius:4px}.skin-file-list{margin-top:20px;max-height:300px;overflow-y:auto}.skin-file-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee;align-items:center}.skin-file-info{display:flex;align-items:center}.skin-file-icon{margin-right:10px;color:#6c757d}.skin-file-status{font-weight:700}.skin-status-pending{color:#ffc107}.skin-status-success{color:#28a745}.skin-status-error{color:#dc3545}.skin-form-group{margin-bottom:15px}.skin-form-group label{display:block;margin-bottom:5px;font-weight:700}.skin-form-group input{width:calc(100% - 2px);padding:10px;border:1px solid #ced4da;border-radius:4px;font-size:14px;box-sizing:border-box}.skin-file-size-limit{color:#6c757d;font-size:14px;margin-top:5px}.skin-preview-link{color:#007bff;text-decoration:none;margin-left:10px}.skin-preview-link:hover{text-decoration:underline}#fileInput{display:none}.captcha-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;z-index:999}.captcha-card{background:var(--card-bg);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.15);width:100%;max-width:380px;overflow:hidden;display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000}.captcha-card-header{padding:16px 20px;border-bottom:1px solid var(--border-color);position:relative}.captcha-card-title{font-size:18px;font-weight:700;margin:0 0 6px;color:var(--text-color)}.captcha-cueword{font-weight:700;color:var(--primary-color)}.captcha-verification-container{padding:8px 16px 8px}.captcha-image-wrapper{width:100%;margin:8px 0 12px;position:relative}.captcha-image-container{position:relative;width:100%;padding-top:100%;overflow:hidden;border:2px solid var(--border-color);border-radius:4px;background:#f9f9f9}.captcha-image-container img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover}.captcha-grid-overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(4,1fr)}.captcha-grid-cell{border:2px solid rgba(0,0,0,.3);transition:all .2s;cursor:pointer;box-sizing:border-box}.captcha-grid-cell:hover{background:var(--hover-bg)}.captcha-grid-cell.selected{background:rgba(161,189,255,.4);border-color:var(--primary-color)}.captcha-card-footer{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;border-top:1px solid var(--border-color)}.captcha-footer-text{font-size:14px;color:#999}.captcha-btn{background:var(--primary-color);color:#fff;border:none;border-radius:4px;padding:6px 14px;font-size:14px;cursor:pointer;transition:background-color .2s}.captcha-btn:hover{background:var(--hover-blue)}.captcha-btn:disabled{background:#ccc;cursor:not-allowed}.captcha-btn-cancel{background:#f1f1f1;color:#666;margin-right:8px}.captcha-btn-cancel:hover{background:#e5e5e5}.captcha-loading{opacity:.6;pointer-events:none}.captcha-success-message,.captcha-error-message{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.7);color:#fff;padding:16px 24px;border-radius:4px;font-weight:700;display:none;z-index:1001}.captcha-error-message{max-width:300px;text-align:center}.captcha-close-btn{position:absolute;top:12px;right:12px;background:0;border:none;font-size:20px;cursor:pointer;color:#999}.captcha-close-btn:hover{color:#333}.card{display:block!important}</style></head><body><div id="header"><button id="menu-btn"><i class="fas fa-bars"></i></button><div id="title">素素の生存服</div></div><div id="sidebar"></div><div id="content"><div class="card active"><h1>上传皮肤到服务器</h1><div class="command-section skin-upload-container"><div class="skin-form-group"><label for="playerId">玩家ID:</label><input type="text" id="playerId" placeholder="请输入你的游戏名" required></div><div class="skin-drop-area" id="dropArea"><p>可拖放文件到此处</p><button class="skin-btn" id="selectBtn">选择文件</button><input type="file" id="fileInput" accept="image/png"><div class="skin-file-size-limit">仅支持原版皮肤(PNG,64×64)</div></div><div class="skin-progress-container" id="progressContainer"><p id="statusText">准备上传...</p><progress class="skin-progress" id="uploadProgress" value="0" max="100"></progress></div><div class="skin-file-list" id="fileList"></div></div></div></div><div class="captcha-overlay" id="captchaOverlay"></div><div class="captcha-card" id="captchaCard"><div class="captcha-card-header"><h2 class="captcha-card-title">请选择所有包含<span id="cueword" class="captcha-cueword">加载中</span>的内容</h2><button class="captcha-close-btn" id="captchaCloseBtn">×</button></div><div class="captcha-verification-container"><div class="captcha-image-wrapper"><div class="captcha-image-container"><img id="captchaImage" alt="验证图片" style="display:none"><div class="captcha-grid-overlay" id="captchaGridOverlay"></div><div id="captchaCenterMessage">正在初始化...</div></div></div></div><div class="captcha-card-footer"><span class="captcha-footer-text">By 阿素本素</span><div><button class="captcha-btn captcha-btn-cancel" id="captchaCancelBtn">取消</button><button class="captcha-btn" id="captchaSubmitBtn" disabled>继续</button></div></div></div><div class="captcha-success-message" id="captchaSuccessMessage">验证成功！</div><div class="captcha-error-message" id="captchaErrorMessage"><div id="captchaErrorText"></div></div><script src="/js/main.js"></script><script>
// 文件选择器相关变量 - 保持关键变量名不变
const dropArea = document.getElementById('dropArea'),
      fileInput = document.getElementById('fileInput'),
      selectBtn = document.getElementById('selectBtn'),
      progressContainer = document.getElementById('progressContainer'),
      uploadProgress = document.getElementById('uploadProgress'),
      statusText = document.getElementById('statusText'),
      fileList = document.getElementById('fileList'),
      playerIdInput = document.getElementById('playerId');

// 验证码相关变量 - 缩短变量名
const captchaOverlay = document.getElementById('captchaOverlay'),
      captchaCard = document.getElementById('captchaCard'),
      captchaGrid = document.getElementById('captchaGridOverlay'),
      captchaSubmit = document.getElementById('captchaSubmitBtn'),
      captchaCancel = document.getElementById('captchaCancelBtn'),
      captchaClose = document.getElementById('captchaCloseBtn'),
      captchaImg = document.getElementById('captchaImage'),
      cueword = document.getElementById('cueword'),
      centerMsg = document.getElementById('captchaCenterMessage'),
      successMsg = document.getElementById('captchaSuccessMessage'),
      errorMsg = document.getElementById('captchaErrorMessage'),
      errorText = document.getElementById('captchaErrorText');

let selectedCells = [], currentToken = '', verificationInProgress = !1, pendingFiles = null, pendingPlayerId = '';

// 创建验证码网格
for(let i=0;i<16;i++){let c=document.createElement('div');c.className='captcha-grid-cell',c.dataset.index=i,c.addEventListener('click',function(){if(verificationInProgress)return;this.classList.toggle('selected');let e=parseInt(this.dataset.index);this.classList.contains('selected')?selectedCells.includes(e)||selectedCells.push(e):selectedCells=selectedCells.filter(t=>t!==e),captchaSubmit.disabled=0===selectedCells.length}),captchaGrid.appendChild(c)}

// 文件选择器事件绑定 - 保持关键事件监听器不变
selectBtn.addEventListener('click',()=>fileInput.click());
fileInput.addEventListener('change',()=>handleFiles(fileInput.files));

// 拖放功能
['dragenter','dragover','dragleave','drop'].forEach(e=>{dropArea.addEventListener(e,t=>{t.preventDefault(),t.stopPropagation()},!1)});
['dragenter','dragover'].forEach(e=>{dropArea.addEventListener(e,()=>dropArea.classList.add('highlight'),!1)});
['dragleave','drop'].forEach(e=>{dropArea.addEventListener(e,()=>dropArea.classList.remove('highlight'),!1)});
dropArea.addEventListener('drop',e=>handleFiles(e.dataTransfer.files),!1);

function handleFiles(e){fileList.innerHTML='';let t=playerIdInput.value.trim();if(!t)return void showError('请先输入玩家ID(p≧w≦q)');let n=Array.from(e).filter(e=>'image/png'===e.type);if(0===n.length)return void showError('请选择PNG格式的皮肤文件(p≧w≦q)');let o=n.filter(e=>e.size>10240);if(o.length>0)return void showError(`文件 "${o[0].name}" 超过10KB限制(p≧w≦q)`);let i=n[0],r=new Image;r.onload=function(){if(64!==this.width||64!==this.height)return void showError('皮肤图片尺寸必须是64x64像素(p≧w≦q)');let e=document.createElement('div');e.className='skin-file-item',e.innerHTML=`<div class="skin-file-info"><span class="skin-file-icon">📄</span><span>${i.name} (${formatSize(i.size)})</span></div><span class="skin-file-status skin-status-pending">等待验证</span>`,fileList.appendChild(e),pendingFiles=n,pendingPlayerId=t,startCaptcha()},r.onerror=()=>showError('无法读取图片文件(p≧w≦q)'),r.src=URL.createObjectURL(i)}

function startCaptcha(){showCaptcha(),initCaptcha()}
function showCaptcha(){captchaCard.style.display='block',captchaOverlay.style.display='block'}
function hideCaptcha(){captchaCard.style.display='none',captchaOverlay.style.display='none'}
async function initCaptcha(){try{setLoading(!0),updateMsg('正在初始化...'),clearToken();let e=await fetch('https://api.azsu.top/5002/captcha/get_token'),t=await e.json();10000===t.code?(currentToken=t.data.captcha_token,updateMsg('正在加载验证图片...'),await loadImage()):(showCaptchaError('获取验证令牌失败: '+t.message),setLoading(!1),hideCaptcha())}catch(e){showCaptchaError('初始化验证失败: '+e.message),setLoading(!1),hideCaptcha()}}
async function loadImage(){try{let e=await fetch(`https://api.azsu.top/5001/captcha?captcha_token=${currentToken}`),t=await e.json();if(16001===t.code||10000===t.code){if(t.data.image_base64&&(captchaImg.src='data:image/jpeg;base64,'+t.data.image_base64,captchaImg.style.display='block',hideMsg()),t.data.cueword&&(cueword.textContent=t.data.cueword),setLoading(!1),16001===t.code&&'processing'===t.data.status)return void setTimeout(async()=>{await loadImage()},1e3)}else showCaptchaError('加载验证图片失败: '+t.message),setLoading(!1),hideCaptcha()}catch(e){showCaptchaError('加载验证图片失败: '+e.message),setLoading(!1),hideCaptcha()}}

captchaSubmit.addEventListener('click',submitCaptcha),captchaCancel.addEventListener('click',cancelCaptcha),captchaClose.addEventListener('click',cancelCaptcha);

async function submitCaptcha(){if(verificationInProgress||0===selectedCells.length)return;verificationInProgress=!0,captchaSubmit.disabled=!0,setLoading(!0),updateMsg('正在验证...');try{let e=await fetch(`https://api.azsu.top/5001/captcha?captcha_token=${currentToken}&selected_cells=${JSON.stringify(selectedCells)}`),t=await e.json();if(16002===t.code||10000===t.code&&'success'===t.data.status){hideCaptcha(),setTimeout(()=>{showSuccess(),storeToken(currentToken),setTimeout(()=>{resetSelection(),uploadFile(pendingFiles[0],pendingPlayerId)},1e3)},10)}else if(16001===t.code&&'processing'===t.data.status){updateMsg('正在加载验证图片...'),t.data.image_base64&&(captchaImg.src='data:image/jpeg;base64,'+t.data.image_base64),t.data.cueword&&(cueword.textContent=t.data.cueword),resetSelection(),setLoading(!1)}else showCaptchaError('验证失败: '+(t.message||'未知错误')),setLoading(!1)}catch(e){showCaptchaError('验证请求失败: '+e.message),setLoading(!1)}verificationInProgress=!1}
function cancelCaptcha(){hideCaptcha(),resetSelection(),pendingFiles=null,pendingPlayerId='',fileList.innerHTML=''}
function resetSelection(){selectedCells=[],document.querySelectorAll('.captcha-grid-cell.selected').forEach(e=>e.classList.remove('selected')),captchaSubmit.disabled=!0}
function setLoading(e){e?(captchaCard.classList.add('captcha-loading'),verificationInProgress=!0):(captchaCard.classList.remove('captcha-loading'),verificationInProgress=!1)}
function updateMsg(e){centerMsg.textContent=e}
function hideMsg(){centerMsg.textContent=''}
function showSuccess(){successMsg.style.display='block',setTimeout(()=>successMsg.style.display='none',1e3)}
function showCaptchaError(e){errorText.textContent=e,errorMsg.style.display='block',setTimeout(()=>errorMsg.style.display='none',3e3)}
function storeToken(e){localStorage.setItem('captcha_token',e),localStorage.setItem('captcha_token_expires',(Math.floor(Date.now()/1e3)+240).toString())}
function clearToken(){localStorage.removeItem('captcha_token'),localStorage.removeItem('captcha_token_expires')}

function uploadFile(e,t){progressContainer.style.display='block',statusText.textContent='准备上传...',statusText.style.color='',uploadProgress.value=0;let n=new FormData;n.append('file',e),n.append('player_id',t),n.append('captcha_token',currentToken);let o=new XMLHttpRequest;o.open('POST','https://api.azsu.top:5003/skin/upload',!0),o.setRequestHeader('Accept','application/json'),o.upload.onprogress=function(e){if(e.lengthComputable){let t=Math.round(e.loaded/e.total*100);uploadProgress.value=t,statusText.textContent=`上传中: ${t}%`;let n=document.querySelector('.skin-file-item');n.querySelector('.skin-file-status').textContent=`${t}%`,n.querySelector('.skin-file-status').className='skin-file-status skin-status-pending'}},o.onload=function(){let e=document.querySelector('.skin-file-item');if(200===this.status||400===this.status)try{let t=JSON.parse(this.responseText);14000===t.code?(statusText.textContent='文件上传成功(p≧w≦q)',statusText.style.color='#28a745',uploadProgress.value=100,updateStatus(e,'上传成功','success'),addPreview(e,t)):(statusText.textContent=t.message||'上传失败',statusText.style.color='#dc3545',updateStatus(e,t.message||'上传失败','error'))}catch(t){statusText.textContent='服务器响应异常',statusText.style.color='#dc3545',updateStatus(e,'服务器异常','error')}else statusText.textContent=`上传失败 (${this.status})`,statusText.style.color='#dc3545',updateStatus(e,`失败: ${this.status}`,'error');fileInput.value='',pendingFiles=null,pendingPlayerId=''},o.onerror=function(){statusText.textContent='网络错误(p≧w≦q)',statusText.style.color='#dc3545';let e=document.querySelector('.skin-file-item');updateStatus(e,'网络错误','error'),fileInput.value='',pendingFiles=null,pendingPlayerId=''},o.send(n)}
function updateStatus(e,t,n){let o=e.querySelector('.skin-file-status');o.textContent=t,o.className=`skin-file-status skin-status-${n}`}
function addPreview(e,t){let n=document.createElement('a');n.href='https://api.azsu.top/skin/file?player='+t,n.textContent='查看皮肤',n.className='skin-preview-link',n.target='_blank',e.appendChild(n)}
function showError(e){statusText.textContent=e,statusText.style.color='#dc3545',progressContainer.style.display='block'}
function formatSize(e){if(0===e)return'0 Bytes';let t=1024,n=['Bytes','KB','MB','GB'],o=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,o)).toFixed(2))+' '+n[o]}
</script></body></html>