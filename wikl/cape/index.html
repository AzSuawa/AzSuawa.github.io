<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上传皮肤到服务器 - 素素の生存服(p≧w≦q)</title>
    <meta name="description" content="上传皮肤到服务器 - 素素の生存服、azsu.top、小小素QQ机器人">
    <meta name="theme-color" content="#A1BDFF">
    <link rel="stylesheet" href="/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" href="/images/favicon.ico">
    <style>
        .skin-upload-container{max-width:500px;margin:0 auto}
        .skin-drop-area{border:2px dashed #6c757d;border-radius:6px;padding:30px;text-align:center;margin-bottom:20px;transition:all .3s;background:#f8f9fa}
        .skin-drop-area.highlight{border-color:#28a745;background:#e8f5e9}
        .skin-btn{background:var(--primary-color);color:white;padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-size:16px;margin:10px 5px;transition:background-color .3s}
        .skin-btn:hover{background:#8CAEFF}
        .skin-progress-container{margin-top:20px;display:none}
        .skin-progress{width:100%;height:20px;border-radius:4px}
        .skin-file-list{margin-top:20px;max-height:300px;overflow-y:auto}
        .skin-file-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee;align-items:center}
        .skin-file-info{display:flex;align-items:center}
        .skin-file-icon{margin-right:10px;color:#6c757d}
        .skin-file-status{font-weight:bold}
        .skin-status-pending{color:#ffc107}
        .skin-status-success{color:#28a745}
        .skin-status-error{color:#dc3545}
        .skin-form-group{margin-bottom:15px}
        .skin-form-group label{display:block;margin-bottom:5px;font-weight:bold}
        .skin-form-group input{width:calc(100% - 2px);padding:10px;border:1px solid #ced4da;border-radius:4px;font-size:14px;box-sizing:border-box}
        .skin-file-size-limit{color:#6c757d;font-size:14px;margin-top:5px}
        .skin-preview-link{color:#007bff;text-decoration:none;margin-left:10px}
        .skin-preview-link:hover{text-decoration:underline}
        #fileInput{display:none}
        .captcha-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;z-index:999}
        .captcha-card{background:var(--card-bg);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.15);width:100%;max-width:380px;overflow:hidden;display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000}
        .captcha-card-header{padding:16px 20px;border-bottom:1px solid var(--border-color);position:relative}
        .captcha-card-title{font-size:18px;font-weight:bold;margin:0 0 6px 0;color:var(--text-color)}
        .captcha-cueword{font-weight:bold;color:var(--primary-color)}
        .captcha-verification-container{padding:8px 16px 8px}
        .captcha-image-wrapper{width:100%;margin:8px 0 12px;position:relative}
        .captcha-image-container{position:relative;width:100%;padding-top:100%;overflow:hidden;border:2px solid var(--border-color);border-radius:4px;background:#f9f9f9}
        .captcha-image-container img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover}
        .captcha-grid-overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(4,1fr)}
        .captcha-grid-cell{border:2px solid rgba(0,0,0,.3);transition:all .2s;cursor:pointer;box-sizing:border-box}
        .captcha-grid-cell:hover{background:var(--hover-bg)}
        .captcha-grid-cell.selected{background:rgba(161,189,255,.4);border-color:var(--primary-color)}
        .captcha-card-footer{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;border-top:1px solid var(--border-color)}
        .captcha-footer-text{font-size:14px;color:#999}
        .captcha-btn{background:var(--primary-color);color:white;border:none;border-radius:4px;padding:6px 14px;font-size:14px;cursor:pointer;transition:background-color .2s}
        .captcha-btn:hover{background:var(--hover-blue)}
        .captcha-btn:disabled{background:#ccc;cursor:not-allowed}
        .captcha-btn-cancel{background:#f1f1f1;color:#666;margin-right:8px}
        .captcha-btn-cancel:hover{background:#e5e5e5}
        .captcha-loading{opacity:.6;pointer-events:none}
        .captcha-success-message,.captcha-error-message{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.7);color:white;padding:16px 24px;border-radius:4px;font-weight:bold;display:none;z-index:1001}
        .captcha-error-message{max-width:300px;text-align:center}
        .captcha-close-btn{position:absolute;top:12px;right:12px;background:none;border:none;font-size:20px;cursor:pointer;color:#999}
        .captcha-close-btn:hover{color:#333}
        .card{display:block!important}
    </style>
</head>
<body>
    <div id="header">
        <button id="menu-btn"><i class="fas fa-bars"></i></button>
        <div id="title">素素の生存服</div>
    </div>
    
    <div id="sidebar"></div>
    
    <div id="content">
        <div class="card active">
            <h1>上传皮肤到服务器</h1>
            <div class="command-section skin-upload-container">
                <div class="skin-form-group">
                    <label for="playerId">玩家ID:</label>
                    <input type="text" id="playerId" placeholder="请输入你的游戏名" required>
                </div>
                <div class="skin-drop-area" id="dropArea">
                    <p>可拖放文件到此处</p>
                    <button class="skin-btn" id="selectBtn">选择文件</button>
                    <input type="file" id="fileInput" accept="image/png">
                    <div class="skin-file-size-limit">仅支持原版皮肤(PNG,64×64)</div>
                </div>
                <div class="skin-progress-container" id="progressContainer">
                    <p id="statusText">准备上传...</p>
                    <progress class="skin-progress" id="uploadProgress" value="0" max="100"></progress>
                </div>
                <div class="skin-file-list" id="fileList"></div>
            </div>
        </div>
    </div>

    <div class="captcha-overlay" id="captchaOverlay"></div>
    <div class="captcha-card" id="captchaCard">
        <div class="captcha-card-header">
            <h2 class="captcha-card-title">请选择所有包含<span id="cueword" class="captcha-cueword">加载中</span>的内容</h2>
            <button class="captcha-close-btn" id="captchaCloseBtn">×</button>
        </div>
        <div class="captcha-verification-container">
            <div class="captcha-image-wrapper">
                <div class="captcha-image-container">
                    <img id="captchaImage" alt="验证图片" style="display:none">
                    <div class="captcha-grid-overlay" id="captchaGridOverlay"></div>
                    <div id="captchaCenterMessage">正在初始化...</div>
                </div>
            </div>
        </div>
        <div class="captcha-card-footer">
            <span class="captcha-footer-text">By 阿素本素</span>
            <div>
                <button class="captcha-btn captcha-btn-cancel" id="captchaCancelBtn">取消</button>
                <button class="captcha-btn" id="captchaSubmitBtn" disabled>继续</button>
            </div>
        </div>
    </div>

    <div class="captcha-success-message" id="captchaSuccessMessage">验证成功！</div>
    <div class="captcha-error-message" id="captchaErrorMessage"><div id="captchaErrorText"></div></div>

    <script src="/js/main.js"></script>
    <script>
        // 皮肤上传功能
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const selectBtn = document.getElementById('selectBtn');
        const progressContainer = document.getElementById('progressContainer');
        const uploadProgress = document.getElementById('uploadProgress');
        const statusText = document.getElementById('statusText');
        const fileList = document.getElementById('fileList');
        const playerIdInput = document.getElementById('playerId');
        
        // 验证码相关变量
        const captchaOverlay = document.getElementById('captchaOverlay');
        const captchaCard = document.getElementById('captchaCard');
        const captchaGridOverlay = document.getElementById('captchaGridOverlay');
        const captchaSubmitBtn = document.getElementById('captchaSubmitBtn');
        const captchaCancelBtn = document.getElementById('captchaCancelBtn');
        const captchaCloseBtn = document.getElementById('captchaCloseBtn');
        const captchaImage = document.getElementById('captchaImage');
        const cuewordElement = document.getElementById('cueword');
        const captchaCenterMessage = document.getElementById('captchaCenterMessage');
        const captchaSuccessMessage = document.getElementById('captchaSuccessMessage');
        const captchaErrorMessage = document.getElementById('captchaErrorMessage');
        const captchaErrorText = document.getElementById('captchaErrorText');
        
        let selectedCells = [];
        let currentToken = '';
        let verificationInProgress = false;
        let pendingFiles = null;
        let pendingPlayerId = '';
        
        // 创建4x4网格
        for (let i = 0; i < 16; i++) {
            const cell = document.createElement('div');
            cell.className = 'captcha-grid-cell';
            cell.dataset.index = i;
            
            cell.addEventListener('click', function() {
                if (verificationInProgress) return;
                
                this.classList.toggle('selected');
                
                const index = parseInt(this.dataset.index);
                if (this.classList.contains('selected')) {
                    if (!selectedCells.includes(index)) {
                        selectedCells.push(index);
                    }
                } else {
                    selectedCells = selectedCells.filter(item => item !== index);
                }
                
                captchaSubmitBtn.disabled = selectedCells.length === 0;
            });
            
            captchaGridOverlay.appendChild(cell);
        }

        // 文件选择器事件绑定
        selectBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        // 拖放功能
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
        });
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const files = e.dataTransfer.files;
            handleFiles(files);
        }
        
        // 处理文件
        function handleFiles(files) {
            fileList.innerHTML = '';
            
            const playerId = playerIdInput.value.trim();
            if (!playerId) {
                showError('请先输入玩家ID(p≧w≦q)');
                return;
            }
            
            const pngFiles = Array.from(files).filter(file => file.type === 'image/png');
            
            if (pngFiles.length === 0) {
                showError('请选择PNG格式的皮肤文件(p≧w≦q)');
                return;
            }
            
            const oversizedFiles = pngFiles.filter(file => file.size > 10 * 1024);
            if (oversizedFiles.length > 0) {
                showError(`文件 "${oversizedFiles[0].name}" 超过10KB限制(p≧w≦q)`);
                return;
            }
            
            const file = pngFiles[0];
            const img = new Image();
            img.onload = function() {
                if (this.width !== 64 || this.height !== 64) {
                    showError('皮肤图片尺寸必须是64x64像素(p≧w≦q)');
                    return;
                }
                
                const fileItem = document.createElement('div');
                fileItem.className = 'skin-file-item';
                fileItem.innerHTML = `
                    <div class="skin-file-info">
                        <span class="skin-file-icon">📄</span>
                        <span>${file.name} (${formatFileSize(file.size)})</span>
                    </div>
                    <span class="skin-file-status skin-status-pending">等待验证</span>
                `;
                fileList.appendChild(fileItem);
                
                pendingFiles = pngFiles;
                pendingPlayerId = playerId;
                
                startCaptchaVerification();
            };
            img.onerror = function() {
                showError('无法读取图片文件(p≧w≦q)');
            };
            img.src = URL.createObjectURL(file);
        }

        // 验证码功能
        function startCaptchaVerification() {
            showCaptcha();
            initVerification();
        }
        
        function showCaptcha() {
            captchaCard.style.display = 'block';
            captchaOverlay.style.display = 'block';
        }
        
        function hideCaptcha() {
            captchaCard.style.display = 'none';
            captchaOverlay.style.display = 'none';
        }
        
        async function initVerification() {
            try {
                setCaptchaLoading(true);
                updateCenterMessage('正在初始化...');
                
                clearCaptchaToken();
                
                const tokenResponse = await fetch('https://api.azsu.top/5002/captcha/get_token');
                const tokenData = await tokenResponse.json();
                
                if (tokenData.code === 10000) {
                    currentToken = tokenData.data.captcha_token;
                    updateCenterMessage('正在加载验证图片...');
                    await loadCaptchaImage();
                } else {
                    showCaptchaError('获取验证令牌失败: ' + tokenData.message);
                    setCaptchaLoading(false);
                    hideCaptcha();
                }
            } catch (error) {
                showCaptchaError('初始化验证失败: ' + error.message);
                setCaptchaLoading(false);
                hideCaptcha();
            }
        }

        async function loadCaptchaImage() {
            try {
                const response = await fetch(`https://api.azsu.top/5001/captcha?captcha_token=${currentToken}`);
                const data = await response.json();
                
                if (data.code === 16001 || data.code === 10000) {
                    if (data.data.image_base64) {
                        captchaImage.src = 'data:image/jpeg;base64,' + data.data.image_base64;
                        captchaImage.style.display = 'block';
                        hideCenterMessage();
                    }
                    if (data.data.cueword) {
                        cuewordElement.textContent = data.data.cueword;
                    }
                    setCaptchaLoading(false);
                } else {
                    showCaptchaError('加载验证图片失败: ' + data.message);
                    setCaptchaLoading(false);
                    hideCaptcha();
                }
            } catch (error) {
                showCaptchaError('加载验证图片失败: ' + error.message);
                setCaptchaLoading(false);
                hideCaptcha();
            }
        }

        // 验证码按钮事件
        captchaSubmitBtn.addEventListener('click', submitCaptcha);
        captchaCancelBtn.addEventListener('click', cancelCaptcha);
        captchaCloseBtn.addEventListener('click', cancelCaptcha);

        async function submitCaptcha() {
            if (verificationInProgress || selectedCells.length === 0) return;
            
            verificationInProgress = true;
            captchaSubmitBtn.disabled = true;
            setCaptchaLoading(true);
            updateCenterMessage('正在验证...');
            
            try {
                const response = await fetch(`https://api.azsu.top/5001/captcha?captcha_token=${currentToken}&selected_cells=${JSON.stringify(selectedCells)}`);
                const data = await response.json();
                
                if (data.code === 16002 || (data.code === 10000 && data.data.status === 'success')) {
                    hideCaptcha();
                    setTimeout(() => {
                        showCaptchaSuccess();
                        storeCaptchaToken(currentToken);
                        setTimeout(() => {
                            resetCaptchaSelection();
                            uploadFile(pendingFiles[0], pendingPlayerId);
                        }, 1000);
                    }, 10);
                } else if (data.code === 16001 && data.data.status === 'processing') {
                    updateCenterMessage('正在加载验证图片...');
                    if (data.data.image_base64) {
                        captchaImage.src = 'data:image/jpeg;base64,' + data.data.image_base64;
                    }
                    if (data.data.cueword) {
                        cuewordElement.textContent = data.data.cueword;
                    }
                    resetCaptchaSelection();
                    setCaptchaLoading(false);
                } else {
                    showCaptchaError('验证失败: ' + (data.message || '未知错误'));
                    setCaptchaLoading(false);
                }
            } catch (error) {
                showCaptchaError('验证请求失败: ' + error.message);
                setCaptchaLoading(false);
            } finally {
                verificationInProgress = false;
            }
        }
        
        function cancelCaptcha() {
            hideCaptcha();
            resetCaptchaSelection();
            pendingFiles = null;
            pendingPlayerId = '';
            fileList.innerHTML = '';
        }
        
        function resetCaptchaSelection() {
            selectedCells = [];
            document.querySelectorAll('.captcha-grid-cell.selected').forEach(cell => {
                cell.classList.remove('selected');
            });
            captchaSubmitBtn.disabled = true;
        }
        
        function setCaptchaLoading(loading) {
            if (loading) {
                captchaCard.classList.add('captcha-loading');
            } else {
                captchaCard.classList.remove('captcha-loading');
            }
            verificationInProgress = loading;
        }
        
        function updateCenterMessage(message) {
            captchaCenterMessage.textContent = message;
        }
        
        function hideCenterMessage() {
            captchaCenterMessage.textContent = '';
        }
        
        function showCaptchaSuccess() {
            captchaSuccessMessage.style.display = 'block';
            setTimeout(() => {
                captchaSuccessMessage.style.display = 'none';
            }, 1000);
        }
        
        function showCaptchaError(message) {
            captchaErrorText.textContent = message;
            captchaErrorMessage.style.display = 'block';
            setTimeout(() => {
                captchaErrorMessage.style.display = 'none';
            }, 3000);
        }
        
        function storeCaptchaToken(token) {
            localStorage.setItem('captcha_token', token);
            localStorage.setItem('captcha_token_expires', (Math.floor(Date.now() / 1000) + 240).toString());
        }
        
        function clearCaptchaToken() {
            localStorage.removeItem('captcha_token');
            localStorage.removeItem('captcha_token_expires');
        }

        // 上传文件
        function uploadFile(file, playerId) {
            progressContainer.style.display = 'block';
            statusText.textContent = '准备上传...';
            statusText.style.color = '';
            uploadProgress.value = 0;
        
            const formData = new FormData();
            formData.append('file', file);
            formData.append('player_id', playerId);
            formData.append('captcha_token', currentToken);
        
            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'https://api.azsu.top:5003/skin/upload', true);
            xhr.setRequestHeader('Accept', 'application/json');
        
            xhr.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    uploadProgress.value = percent;
                    statusText.textContent = `上传中: ${percent}%`;
                
                    const fileItem = document.querySelector('.skin-file-item');
                    fileItem.querySelector('.skin-file-status').textContent = `${percent}%`;
                    fileItem.querySelector('.skin-file-status').className = 'skin-file-status skin-status-pending';
                }
            };
        
            xhr.onload = function() {
                const fileItem = document.querySelector('.skin-file-item');
        
                if (xhr.status === 200 || xhr.status === 400) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.code === 14000) {
                            statusText.textContent = '文件上传成功(p≧w≦q)';
                            statusText.style.color = '#28a745';
                            uploadProgress.value = 100;
                            updateFileStatus(fileItem, '上传成功', 'success');
                            addPreviewLink(fileItem, playerId);
                        } else {
                            statusText.textContent = response.message || '上传失败';
                            statusText.style.color = '#dc3545';
                            updateFileStatus(fileItem, response.message || '上传失败', 'error');
                        }
                    } catch (e) {
                        statusText.textContent = '服务器响应异常';
                        statusText.style.color = '#dc3545';
                        updateFileStatus(fileItem, '服务器异常', 'error');
                    }
                } else {
                    statusText.textContent = `上传失败 (${xhr.status})`;
                    statusText.style.color = '#dc3545';
                    updateFileStatus(fileItem, `失败: ${xhr.status}`, 'error');
                }
        
                fileInput.value = '';
                pendingFiles = null;
                pendingPlayerId = '';
            };
        
            xhr.onerror = function() {
                statusText.textContent = '网络错误(p≧w≦q)';
                statusText.style.color = '#dc3545';
                const fileItem = document.querySelector('.skin-file-item');
                updateFileStatus(fileItem, '网络错误', 'error');
            
                fileInput.value = '';
                pendingFiles = null;
                pendingPlayerId = '';
            };
        
            xhr.send(formData);
        }
            
        function updateFileStatus(fileItem, text, type) {
            const statusSpan = fileItem.querySelector('.skin-file-status');
            statusSpan.textContent = text;
            statusSpan.className = `skin-file-status skin-status-${type}`;
        }
        
        function addPreviewLink(fileItem, playerId) {
            const previewLink = document.createElement('a');
            previewLink.href = 'https://api.azsu.top/skin/file?player=' + playerId;
            previewLink.textContent = '查看皮肤';
            previewLink.className = 'skin-preview-link';
            previewLink.target = '_blank';
            fileItem.appendChild(previewLink);
        }
        
        function showError(message) {
            statusText.textContent = message;
            statusText.style.color = '#dc3545';
            progressContainer.style.display = 'block';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>