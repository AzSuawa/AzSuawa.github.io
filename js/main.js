// 页面元数据配置
const pageMetaData = {
    'aa': {
        title: '小小素(p≧w≦q)',
        description: '素素の生存服、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '小小素BOT'
    },
    'ab': {
        title: '常见问题 - 小小素(p≧w≦q)',
        description: '素素の生存服、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '常见问题'
    },
    'ac': {
        title: '鸣谢和赞助 - 小小素(p≧w≦q)',
        description: '素素の生存服、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '鸣谢和赞助'
    },
    'cmds': {
        title: '指令帮助 - 小小素(p≧w≦q)',
        description: '素素の生存服、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '指令帮助'
    },
    'api': {
        title: '小小素API - 小小素(p≧w≦q)',
        description: 'Minecraft服务器Motd查询、2b2t.org数据图片查询',
        headerTitle: '小小素API'
    },
    'bot-update': {
        title: '更新日志 - 小小素(p≧w≦q)',
        description: '小小素BOT的版本更新历史记录',
        headerTitle: '小小素更新日志'
    },
    'skin': {
        title: '上传皮肤到服务器 - 素素の生存服(p≧w≦q)',
        description: '上传皮肤到服务器 - 素素の生存服(p≧w≦q)、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '素素の生存服'
    },
    'mcp': {
        title: 'Minecraft服务器状态查询API - 阿素本素(p≧w≦q)',
        description: 'Minecraft服务器状态查询API - 素素の生存服(p≧w≦q)、Motd、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '小小素API'
    },
    'ba': {
        title: '素素の生存服 - 阿素本素(p≧w≦q)',
        description: '素素の生存服、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '素素の生存服'
    },
    'bb': {
        title: '机制修改 - 素素の生存服(p≧w≦q)',
        description: '素素の生存服、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '机制修改'
    },
    'ban': {
        title: '封禁列表 - 素素の生存服(p≧w≦q)',
        description: '素素の生存服、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '封禁列表'
    },
    'sp': {
        title: '赞助列表 - 素素の生存服(p≧w≦q)',
        description: '素素の生存服、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '赞助列表'
    },
    'g': {
        title: '小故事 - 阿素本素(p≧w≦q)',
        description: '素素の生存服、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '小故事'
    },
    'ban-qwqwcllwww': {
        title: 'ban-qwqwcllwww - 素素の生存服(p≧w≦q)',
        description: '素素の生存服、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '封禁详情'
    },
    'ban-mam1145': {
        title: 'ban-mam1145 - 素素の生存服(p≧w≦q)',
        description: '素素の生存服、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '封禁详情'
    },
    'ban-iuhiuhne': {
        title: 'ban-iuhiuhne - 素素の生存服(p≧w≦q)',
        description: '素素の生存服、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '封禁详情'
    },
    'ban-sudpkkkk': {
        title: 'ban-sudpkkkk - 素素の生存服(p≧w≦q)',
        description: '素素の生存服、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '封禁详情'
    },
    'default': {
        title: '阿素本素(p≧w≦q)',
        description: '素素の生存服、azsu.top、小小素QQ机器人、API接口、MC服务器、Minecraft、我的世界、麦块',
        headerTitle: '素素の生存服'
    }
};

// 页面内容映射
const pageContentMap = {
    'aa': '/pages/aa.html',
    'ab': '/pages/ab.html',
    'ac': '/pages/ac.html',
    'cmds': '/pages/cmds.html',
    'ba': '/pages/ba.html',
    'bb': '/pages/bb.html',
    'ban': '/pages/ban.html',
    'g': '/pages/g.html',
    'mcp': '/mcp.html',
    'skin': '/skin.html',
    'api': '/pages/api.html',
    'sp': '/pages/sp.html',
    'bot-update': '/pages/bot-update.html',
    'ban-qwqwcllwww': '/pages/ban/qwqwcllwww.html',
    'ban-mam1145': '/pages/ban/mam1145.html',
    'ban-iuhiuhne': '/pages/ban/iuhiuhne.html',
    'ban-sudpkkkk': '/pages/ban/sudpkkkk.html'
};

// 检测用户类型
function getUserType() {
    const ua = navigator.userAgent.toLowerCase();
    
    // 检测搜索引擎爬虫
    if (ua.includes('googlebot') || ua.includes('bingbot') || 
        ua.includes('baiduspider') || ua.includes('yandexbot') ||
        ua.includes('slurp') || ua.includes('duckduckbot')) {
        return 'search_engine';
    }
    
    // 检测普通用户
    return 'normal_user';
}

// 检测是否静态页面
function isStaticPage() {
    const ssrData = document.getElementById('ssr-data');
    return ssrData && JSON.parse(ssrData.textContent).isStatic;
}

// 获取当前静态页面ID
function getStaticPageId() {
    const ssrData = document.getElementById('ssr-data');
    return ssrData ? JSON.parse(ssrData.textContent).pageId : null;
}

// 智能路由处理 - 针对搜索引擎优化
function handleSmartRouting() {
    const userType = getUserType();
    const path = window.location.pathname;
    const pageId = path.substring(1) || 'api';
    
    // 有效的页面ID列表
    const validPages = [
        'aa', 'ab', 'ac', 'cmds', 'api', 'bot-update', 
        'ba', 'bb', 'ban', 'sp', 'g', 'mcp', 'skin',
        'ban-qwqwcllwww', 'ban-mam1145', 'ban-iuhiuhne', 'ban-sudpkkkk'
    ];
    
    // 如果是搜索引擎爬虫，且访问的是路由路径（非.html），重定向到静态页面
    if (userType === 'search_engine' && 
        path !== '/' && 
        !path.endsWith('.html') && 
        validPages.includes(pageId)) {
        
        // 检查静态页面是否存在
        const staticUrl = `/${pageId}.html`;
        console.log('搜索引擎重定向到:', staticUrl);
        
        // 使用 replace 避免产生历史记录
        window.location.replace(staticUrl);
        return false; // 停止后续执行
    }
    
    return true; // 继续正常执行
}

// 路由状态管理
let router = {
    currentPage: null,
    isLoading: false
};

document.addEventListener('DOMContentLoaded', function() {
    console.log('页面加载完成，用户类型:', getUserType());
    
    // 先执行智能路由检测
    if (!handleSmartRouting()) {
        console.log('已重定向到静态页面，停止SPA初始化');
        return; // 如果是搜索引擎，已经跳转，停止执行SPA逻辑
    }
    
    // 正常用户的SPA初始化
    console.log('初始化SPA应用');
    
    // 初始化路由系统
    initRouter();
    
    // 初始化菜单状态
    initMenu();
});

// 初始化路由系统
function initRouter() {
    // 处理初始路由
    handleInitialRoute();
    
    // 设置导航事件监听器
    setupNavigation();
}

function handleInitialRoute() {
    const path = window.location.pathname;
    const hash = window.location.hash;
    
    console.log('初始路由处理:', { path, hash, isStatic: isStaticPage() });
    
    // 如果是静态页面，显示静态内容
    if (isStaticPage()) {
        const staticPageId = getStaticPageId();
        router.currentPage = staticPageId;
        console.log('静态页面模式:', staticPageId);
        
        // 显示静态内容
        showStaticContent(staticPageId);
        return;
    }
    
    // 处理哈希路由重定向（仅当路径为根路径时）
    if (hash && path === '/') {
        const cleanPath = hash.substring(1);
        if (pageContentMap[cleanPath]) {
            history.replaceState({ pageId: cleanPath, isSPA: true }, null, '/' + cleanPath);
            updatePageMeta(cleanPath);
            loadPageContent(cleanPath);
            return;
        }
    }
    
    // 处理SPA路由
    const pageId = path.substring(1) || 'api';
    if (pageContentMap[pageId]) {
        updatePageMeta(pageId);
        loadPageContent(pageId);
    } else {
        // 无效路径重定向到api页面
        history.replaceState({ pageId: 'api', isSPA: true }, null, '/api');
        updatePageMeta('api');
        loadPageContent('api');
    }
}

function setupNavigation() {
    // 导航链接点击事件
    document.querySelectorAll('#sidebar a[href^="/"]').forEach(link => {
        link.addEventListener('click', async function(e) {
            e.preventDefault();
            
            const path = this.getAttribute('href');
            const pageId = path.substring(1);
            
            // 避免重复加载相同页面
            if (router.currentPage === pageId || router.isLoading) {
                console.log('跳过重复加载:', pageId);
                return;
            }
            
            console.log('导航到页面:', pageId);
            
            // 更新活动菜单项
            updateActiveMenuItem(this);
            
            // 更新URL和元数据
            history.pushState({ pageId, isSPA: true }, null, path);
            updatePageMeta(pageId);
            await loadPageContent(pageId);
            
            // 更新当前页面标记
            router.currentPage = pageId;
            
            // 移动端点击后自动关闭侧边栏
            if (window.innerWidth <= 1023) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('content').classList.remove('shifted');
            }
        });
    });

    // 处理浏览器前进/后退
    window.addEventListener('popstate', function(event) {
        let pageId;
        let isSPA = false;
        
        if (event.state) {
            pageId = event.state.pageId;
            isSPA = event.state.isSPA;
        } else {
            const path = window.location.pathname;
            pageId = path.substring(1) || 'api';
            isSPA = true;
        }
        
        console.log('popstate事件:', { pageId, isSPA, current: router.currentPage });
        
        // 避免重复加载相同页面
        if (router.currentPage === pageId) return;
        
        const menuItem = document.querySelector(`[data-page="${pageId}"]`);
        if (menuItem) {
            updateActiveMenuItem(menuItem);
            updatePageMeta(pageId);
            loadPageContent(pageId);
            router.currentPage = pageId;
        } else {
            updatePageMeta('api');
            loadPageContent('api');
            router.currentPage = 'api';
        }
    });
}

// 显示静态内容
function showStaticContent(pageId) {
    const staticContent = document.getElementById('static-content');
    const dynamicContent = document.getElementById('dynamic-content');
    
    if (staticContent) {
        staticContent.style.display = 'block';
        if (dynamicContent) {
            dynamicContent.style.display = 'none';
        }
        
        // 激活静态内容中的卡片
        const cards = staticContent.querySelectorAll('.card');
        cards.forEach(card => card.classList.add('active'));
        
        // 更新菜单激活状态
        updateMenuActiveState(pageId);
    }
    
    // 更新页面元数据
    updatePageMeta(pageId);
    
    window.scrollTo(0, 0);
    console.log('显示静态内容:', pageId);
}

// 更新菜单激活状态
function updateMenuActiveState(pageId) {
    document.querySelectorAll('#sidebar li').forEach(item => {
        item.classList.remove('active');
    });
    
    const activeItem = document.querySelector(`[data-page="${pageId}"]`);
    if (activeItem) {
        activeItem.parentElement.classList.add('active');
    }
}

// 初始化菜单功能
function initMenu() {
    // 菜单按钮点击事件
    const menuBtn = document.getElementById('menu-btn');
    if (menuBtn) {
        menuBtn.addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
            
            if (window.innerWidth <= 1023) {
                sidebar.classList.toggle('active');
                content.classList.toggle('shifted');
            }
        });
    }

    // 折叠菜单功能
    document.querySelectorAll('.group-header').forEach(header => {
        header.addEventListener('click', function() {
            const group = this.parentElement;
            const submenu = this.nextElementSibling;
            const icon = this.querySelector('.toggle');
            
            group.classList.toggle('active');
            
            if (group.classList.contains('active')) {
                submenu.style.display = 'block';
                icon.classList.replace('fa-chevron-right', 'fa-chevron-down');
            } else {
                submenu.style.display = 'none';
                icon.classList.replace('fa-chevron-down', 'fa-chevron-right');
            }
        });
    });
}

// 更新活动菜单项
function updateActiveMenuItem(clickedItem) {
    document.querySelectorAll('#sidebar li').forEach(item => {
        item.classList.remove('active');
    });
    
    if (clickedItem && clickedItem.parentElement) {
        clickedItem.parentElement.classList.add('active');
    }
}

// 更新页面元数据
function updatePageMeta(pageId) {
    const metaData = pageMetaData[pageId] || pageMetaData['default'];
    
    // 更新title
    document.title = metaData.title;
    
    // 更新meta description
    let metaDesc = document.querySelector('meta[name="description"]');
    if (!metaDesc) {
        metaDesc = document.createElement('meta');
        metaDesc.name = 'description';
        document.head.appendChild(metaDesc);
    }
    metaDesc.content = metaData.description;
    
    // 更新header标题
    const headerTitle = document.getElementById('title');
    if (headerTitle) {
        headerTitle.textContent = metaData.headerTitle;
    }
    
    console.log('更新页面元数据:', pageId, metaData.title);
}

// 加载页面内容
async function loadPageContent(pageId) {
    // 设置加载状态
    router.isLoading = true;
    
    const staticContent = document.getElementById('static-content');
    const dynamicContent = document.getElementById('dynamic-content');
    
    console.log('开始加载页面内容:', pageId);
    
    try {
        // 隐藏静态内容，显示动态内容
        if (staticContent) {
            staticContent.style.display = 'none';
        }
        if (dynamicContent) {
            dynamicContent.style.display = 'block';
        }
        
        // 动态加载内容
        const response = await fetch(pageContentMap[pageId]);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const html = await response.text();
        
        if (dynamicContent) {
            dynamicContent.innerHTML = html;
            
            // 激活所有卡片
            const cards = dynamicContent.querySelectorAll('.card');
            if (cards.length > 0) {
                cards.forEach(card => card.classList.add('active'));
            }
        }

        window.scrollTo(0, 0);
        console.log('页面内容加载成功:', pageId);
        
    } catch (err) {
        console.error('加载失败:', err);
        if (dynamicContent) {
            dynamicContent.innerHTML = `
                <div class="card active error">
                    <h1>加载失败(＞﹏＜)</h1>
                    <p>${err.message}</p>
                    <p>请检查网络连接或稍后重试</p>
                    <button onclick="location.reload()" class="retry-btn">刷新页面</button>
                    <button onclick="window.location.href='/'" class="home-btn">返回首页</button>
                </div>
            `;
            
            // 添加重试按钮样式
            const style = document.createElement('style');
            style.textContent = `
                .retry-btn, .home-btn {
                    background-color: #A1BDFF;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    margin: 5px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                }
                .retry-btn:hover, .home-btn:hover {
                    background-color: #8CAEFF;
                }
            `;
            document.head.appendChild(style);
        }
    } finally {
        router.isLoading = false;
    }
}

// 响应式处理
window.addEventListener('resize', function() {
    const sidebar = document.getElementById('sidebar');
    const content = document.getElementById('content');
    
    if (window.innerWidth > 1023) {
        if (sidebar) sidebar.classList.remove('active');
        if (content) content.classList.remove('shifted');
    }
});

// 页面可见性变化处理（SEO优化）
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
        // 页面重新可见时，确保显示正确内容
        const currentPage = router?.currentPage || getStaticPageId();
        if (currentPage) {
            updatePageMeta(currentPage);
        }
    }
});

// 错误处理
window.addEventListener('error', function(e) {
    console.error('全局错误:', e.error);
});

window.addEventListener('unhandledrejection', function(e) {
    console.error('未处理的Promise拒绝:', e.reason);
});

// 导出全局函数（用于调试）
window.getCurrentPageInfo = function() {
    return {
        currentPage: router.currentPage,
        isStatic: isStaticPage(),
        staticPageId: getStaticPageId(),
        userType: getUserType(),
        pageMetaData: pageMetaData[router.currentPage]
    };
};

console.log('main.js 加载完成');